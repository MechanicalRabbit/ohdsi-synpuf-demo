# New users of ACE inhibitors as first-line monotherapy for hypertension

This test case demonstrates the construction of a domain specific
language specific to the generation of OHDSI Cohorts. To get started,
we'll import some boilerplate definitions. This will create the
*DataKnot* called `sp10` that represents our test database.

    include("copybook.jl")

We implement the cohort definition as found in found in `1770675.sql`
that was produced by the JSON found in `1770675.json`.

## Concept Set Definitions

This cohort defines 3 concept sets: (a) a diagnosis of hypertension,
(b) exposure to a hypertension drug, and (c) exposure to ace inhibitor.

    @define is_hypertensive =
         iscoded("SNOMED", 38341003)
    @define is_hypertension_drug =
         iscoded("RxNorm", 149, 325646, 17767, 1091643, 11170,
             644, 1202, 18867, 1520, 19484, 1808, 214354, 1998, 20352,
             2409, 2599, 3443, 49276, 3827, 298869, 83515, 4316, 50166,
             4603, 40114, 5470, 5487, 5764, 83818, 33910, 6185, 29046,
             52175, 6876, 6916, 6918, 6984, 30131, 7226, 31555, 7396,
             7417, 7435, 321064, 7973, 54552, 8332, 8629, 8787, 35208,
             35296, 9997, 73494, 37798, 38413, 38454, 10763, 69749)
    @define is_ace_inhibitor =
         iscoded("RxNorm", 18867, 1998, 3827, 50166, 29046,
             30131, 54552, 35208, 35296, 38454)

## Initial Events

The initial event is described as:

> People having any of the following: a drug exposure of ACE inhibitors
> for the first time in the person's history

    @define candidate_events = begin
        person.keep(it)
        first(begin
                drug_exposure
                filter(concept.is_ace_inhibitor)
                sort(start_date)
        end)
        keep(index_date => start_date)
    end

    @query sp10 candidate_events{ person, index_date }
    #=>
      │ person  index_date │
    ──┼────────────────────┼
    1 │ 30091   2009-03-28 │
    2 │ 42383   2009-11-06 │
    3 │ 69985   2009-05-05 │
    4 │ 82328   2009-08-24 │
    5 │ 110862  2010-04-05 │
    =#

This initial event must occur after an observation period of 1 year has
passed.

> with continuous observation of at least 365 days prior and 0 days
> after event index date, and limit initial events to: earliest event
> per person

    @define with_continuous_observation = begin
        keep(continuous_observation =>
              person.observation_period.
                 filter(includes(index_date.and_prior(365days))).
                 is0to1())
        filter(exists(continuous_observation))
    end

    @query sp10 begin
        candidate_events
        with_continuous_observation
        { person,
          period_start => continuous_observation.start_date,
          index_date,
          period_end => continuous_observation.end_date }
    end
    #=>
      │ person  period_start  index_date  period_end │
    ──┼──────────────────────────────────────────────┼
    1 │ 30091   2008-02-09    2009-03-28  2010-07-20 │
    2 │ 42383   2008-01-04    2009-11-06  2010-08-28 │
    3 │ 69985   2008-02-07    2009-05-05  2010-11-14 │
    4 │ 82328   2008-05-01    2009-08-24  2010-06-19 │
    5 │ 110862  2008-01-04    2010-04-05  2010-09-13 │
    =#


