# New users of ACE inhibitors as first-line monotherapy for hypertension

This test case demonstrates the construction of a domain specific
language specific to the generation of OHDSI Cohorts. To get started,
we'll import some boilerplate definitions. This will create the
*DataKnot* called `sp10` that represents our test database.

    include("copybook.jl")

We implement the cohort definition as found in found in `1770675.sql`
that was produced by the JSON found in `1770675.json`.

    @define is_hypertensive =
         concept.iscoded("SNOMED", 38341003)
    @define is_hypertension_drug =
         concept.iscoded("RxNorm", 149, 325646, 17767, 1091643, 11170,
             644, 1202, 18867, 1520, 19484, 1808, 214354, 1998, 20352,
             2409, 2599, 3443, 49276, 3827, 298869, 83515, 4316, 50166,
             4603, 40114, 5470, 5487, 5764, 83818, 33910, 6185, 29046,
             52175, 6876, 6916, 6918, 6984, 30131, 7226, 31555, 7396,
             7417, 7435, 321064, 7973, 54552, 8332, 8629, 8787, 35208,
             35296, 9997, 73494, 37798, 38413, 38454, 10763, 69749)
    @define is_ace_inhibitor =
         concept.iscoded("RxNorm", 18867, 1998, 3827, 50166, 29046,
             30131, 54552, 35208, 35296, 38454)

    @query sp10 begin
        person.keep(it)
        each(begin
            drug_exposure
            filter(is_ace_inhibitor)
            sort(start_date)
            first()
            keep(index_date => start_date)
            keep(this_period =>
                  person.observation_period.
                     filter(includes(index_date)).is0to1())
        end)
        new_users_of_ace_cohort =>
            { person,
              cohort_entry => start_date,
              cohort_exit => min(start_date + 7days,
                                 this_period.end_date) }
    end
    #=>
      │ new_users_of_ace_cohort           │
      │ person  cohort_entry  cohort_exit │
    ──┼───────────────────────────────────┼
    1 │ 30091   2009-03-28    2009-04-04  │
    2 │ 42383   2009-11-06    2009-11-13  │
    3 │ 69985   2009-05-05    2009-05-12  │
    4 │ 82328   2009-08-24    2009-08-31  │
    5 │ 110862  2010-04-05    2010-04-12  │
    =#

#           keep(acute_visit =>
#                 person.visit.filter(is_inpatient_or_er &&
#                                     includes(index_interval) &&
#                                     during(this_period)))
#           filter(is_myocardial_infarction && exists(acute_visit))
#            index_interval.date_interval(start_date,
#                min(start_date + 7days, this_period.end_date))
#            collapse_intervals(0days)
